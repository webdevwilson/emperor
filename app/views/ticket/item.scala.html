@(ticket: models.FullTicket,
  links: Map[String,List[models.FullLink]],
  assignees: List[(String,String)],
  resolutions: List[(String,String)],
  assignForm: Form[models.Assignment],
  commentForm: Form[models.Comment],
  resolveForm: Form[models.Resolution],
  previousStatus: Option[WorkflowStatus],
  nextStatus: Option[WorkflowStatus],
  linkTypes: List[models.TicketLinkType]
)(content: Html)(implicit request: AuthenticatedRequest)

@import emp.text.Renderer
@import helper.bootstrap._
@import views.html.util._

@main(title = Messages("ticket.with.id", ticket.ticketId), currentProject = Some(ticket.project.id)) {
<div class="row-fluid">

 <div class="span2">
  <div id="ticket-info" class="well well-small" data-spy="affix" data-offset-top="0">
   <div class="btn-group">
    <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
      @ticket.ticketId
      <span class="caret"></span>
    </a>
    <ul class="dropdown-menu">
     <li><a href="@routes.Ticket.edit(ticket.ticketId)"><i class="icon-edit"></i> @Messages("ticket.action.edit")</a></li>
     <li><a data-toggle="modal" href="#assigner"><i class="icon-user"></i> @Messages("ticket.action.assign")</a></li>
    </ul>
   </div>
   <span class="label label-prime">@if(ticket.resolution.id.isDefined) { @Messages(ticket.resolution.name.getOrElse("TICK_RESO_UNRESOLVED")) } else { @Messages(ticket.status.name) }</span>
   <label>@Messages("ticket.type")</label>
   <span class="label" style="background-color: #@ticket.ttype.color">@Messages(ticket.ttype.name)</span>
   <label>@Messages("ticket.date_created")</label>
   <span class="label">@ticket.dateCreated</span>
   <label>@Messages("ticket.reporter")</label>
   <span class="label">@ticket.reporter.name</span>
   <label>@Messages("ticket.assignee")</label>
   <span class="label">@ticket.assignee.name.getOrElse(Messages("ticket.unassigned"))</span>
   <label>@Messages("ticket.priority")</label>
   <span class="label" style="background-color: #@ticket.priority.color">@Messages(ticket.priority.name)</span>
   <label>@Messages("ticket.severity")</label>
   <span class="label" style="background-color: #@ticket.severity.color">@Messages(ticket.severity.name)</span>
  </div>
 </div>

<div class="span10">
 <div id="ticket-head" data-ticket="@ticket.ticketId">
 <div class="row-fluid" id="ticket-header" data-ticket="@ticket.ticketId">
  <h2>
    @Messages("ticket.summary.with.id", ticket.ticketId, ticket.summary)
  </h2>
  <div class="btn-toolbar pull-right">
   @if(ticket.resolution.id.isEmpty) {
   <div class="btn-group">
    @previousStatus match {
     case Some(status) => {
    <a href="#status-revert" class="btn btn-warning" data-toggle="modal"><i class="icon-arrow-left icon-white"></i> @Messages("ticket.revert", Messages(status.name))</a>
     }
     case None => { }
     }
    <a href="#" class="btn disabled">@Messages(ticket.status.name)</a>
    @nextStatus match {
     case Some(status) => {
    <a class="btn btn-primary" data-toggle="modal" id="btn-advance" href="#status-advance">@Messages("ticket.advance", Messages(status.name)) <i class="icon-arrow-right icon-white"></i></a>
     }
     case None => {
    <a href="#" class="btn disabled">@Messages("ticket.advance.end")</a>
     }
    }
   </div>
   }
   <div class="btn-group">
    @if(ticket.resolution.id.isDefined) {
    <a class="btn btn-danger" data-toggle="modal" href="#unresolver"><i class="icon-repeat icon-white"></i> @Messages("ticket.unresolve")</a>
    } else {
    <a class="btn btn-success" data-toggle="modal" href="#resolver"><i class="icon-ok icon-white"></i> @Messages("ticket.resolve")</a>
    }
   </div>
  </div>
 </div>
</div>


   <div class="well well-small ticket-desc">
    @if(ticket.description.isDefined) {
      @Html(Renderer.render(ticket.description))
    } else {
      @Messages("ticket.description.none")
    }
   </div>
   <div id="link-body">
   @if(!links.isEmpty) {
    <h4><a class="accordion-toggle" data-toggle="collapse" data-parent="#link-body" href="#link-contents"><i class="icon-foo"></i>@Messages("ticket.links")</a></h4>
    <div id="link-contents" class="accordion-body collapse in">
    <div class="accordion-inner">
      <table class="table table-striped table-condensed ticket-links">
      @links.map { lmem =>
        @lmem._2.zipWithIndex.map { case(l,index) =>
          <tr>
          @if(index == 0) {
          <td rowspan="@lmem._2.size" class="type">@Messages(lmem._1)</td>
          }
          @if(l.childId == ticket.ticketId) {
            <td class="link"><a @if(l.parentResolutionId.isDefined) { class="strike" } href="@controllers.routes.Ticket.item("comments", l.parentId)">@l.parentId</a></td><td class="summ">@l.parentSummary</td>
          } else {
            <td class="link"><a @if(l.childResolutionId.isDefined) { class="strike" } href="@controllers.routes.Ticket.item("comments", l.childId)">@l.childId</a></td><td class="summ">@l.childSummary</td>
          }
          <td class="actions"><a href="#"><i data-linkid="@l.id" class="remover icon-remove"></a></td>
          </tr>
        }
      }
      </table>
    </div>
    </div>
   }
   </div>
   <div id="tabarea">
    @content
    </div>
<script>
YUI().use('pjax', function (Y) {
    new Y.Pjax({
      container: '#tabarea',
      contentSelector: '.tabcontent'
    });
});
</script>
 </div>
</div>

@if(nextStatus.isDefined) {
<div class="modal hide" id="status-advance">
 @helper.form(action = routes.Ticket.status(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.advance", Messages(nextStatus.get.name))</h3>
 </div>
 <div class="modal-body">
  <fieldset>
   <input type="hidden" name="status_id" value="@nextStatus.get.id.get">
   @helper.textarea(field = commentForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xxlarge", 'rows -> 5)
  </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn" data-dismiss="modal">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
}
@if(previousStatus.isDefined) {
<div class="modal hide" id="status-revert">
 @helper.form(action = routes.Ticket.status(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.revert", Messages(previousStatus.get.name))</h3>
 </div>
 <div class="modal-body">
  <fieldset>
   <input type="hidden" name="status_id" value="@previousStatus.get.id.get">
   @helper.textarea(field = commentForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xxlarge", 'rows -> 5)
  </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn" data-dismiss="modal">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
}
<div class="modal hide" id="resolver">
 @helper.form(action = routes.Ticket.doResolve(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.resolve")</h3>
 </div>
 <div class="modal-body">
  <p>@Html(Messages("ticket.resolve.summary", ticket.ticketId))</p>
  <fieldset>
   @helper.select(field = resolveForm("resolution_id"), options = resolutions, args = '_label -> Messages("ticket.resolution"))
   @helper.textarea(field = resolveForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xlarge", 'rows -> 5)
  </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn" data-dismiss="modal">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
<div class="modal hide" id="unresolver">
 @helper.form(action = routes.Ticket.doUnResolve(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.unresolve")</h3>
 </div>
 <div class="modal-body">
   <p>@Html(Messages("ticket.unresolve.summary", ticket.ticketId))</p>
   <fieldset>
     @helper.textarea(field = commentForm("content"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xxlarge", 'rows -> 5)
   </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn" data-dismiss="modal">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
<div class="modal hide" id="assigner">
 @helper.form(action = routes.Ticket.doAssign(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.assign")</h3>
 </div>
 <div class="modal-body">
   <p>@Html(Messages("ticket.assign.summary", ticket.ticketId))</p>
   <fieldset>
     @helper.select(field = assignForm("user_id"), options = assignees, args = '_label -> Messages("ticket.assignee"))
     @helper.textarea(field = assignForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xxlarge", 'rows -> 5)
   </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn" data-dismiss="modal">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
<script type="text/javascript">
  YUI().use('emperor-models', 'base', 'view', 'node', 'pjax', 'io-base', function (Y) {

    var refreshLinks = function (transactionid, response, arguments) {
      var pjax = new Y.Pjax({
        container: '#link-body',
        contentSelector: '#link-body'
      });
      pjax.navigate('@controllers.routes.Ticket.item("comments", ticket.ticketId)');
    }

    var showAlert = function (transactionId, response, arguments) {
      Y.ShowAlert('alert-error', response.responseText);
    }

    Y.LinkerView = Y.Base.create('linkerView', Y.View, [], {
      events: {
        '#btn-start': { click: 'start' },
        '.remover': { click: 'stop' },
        '.linker': { click: 'link' }
      },
      template: Y.one("#linker-template").getHTML(),
      initializer: function () {
        var model = this.get('model');

        model.after('change', this.render, this);
        model.after('destroy', this.render, this);
      },
      render: function () {
        var container = this.get('container');
        var source   = this.template;
        var template = Handlebars.compile(source);
        var html = template(this.get('model').toJSON());

        container.setHTML(html);

        return this;
      },
      start: function(e) {
        var model = this.get('model');
        model.set("ticket_id", '@ticket.ticketId').save();
      },
      stop: function(e) {
        var model = this.get('model');
        // Causes a PUT with an empty ticket id. Hackish
        model.set("ticket_id", null).save();
      },
      link: function(e) {
        var model = this.get('model');
        var t = e.currentTarget;
        var type = t.getAttribute('data-linktype');
        var invert = t.getAttribute('data-inverse');

        var ticketId = '@ticket.ticketId';
        var childId = model.get("ticket_id");
        if(invert == 'true') {
          ticketId = model.get("ticket_id");
          childId = '@ticket.ticketId';
        }

        var uri = '/api/ticket/link/' + ticketId

        var link = {
          link_type_id: parseInt(type),
          child_ticket_id: childId
        };

        var cfg = {
          method: 'PUT',
          data: JSON.stringify(link),
          headers: {
            'Content-Type': 'application/json',
          },
          on: {
            success: refreshLinks,
            failure: showAlert
          }
        };

        var request = Y.io(uri, cfg);
      }
    }, {
      ATTRS: {
        container: {
          valueFn: function () {
            return Y.one('#linker');
          }
        }
      }
    });

    var linkTicket = new Y.LinkTicket({ id: '@ticket.ticketId' });
    linkTicket.load();

    var linkerView = new Y.LinkerView({ model: linkTicket });
    linkerView.render();

    Y.one("#link-body").delegate('click', function(e) {
      var linkid = e.currentTarget.getAttribute('data-linkid');

      var uri = '/api/ticket/link/@ticket.ticketId/' + linkid

      var cfg = {
        method: 'DELETE',
        on: {
          success: refreshLinks,
          failure: showAlert
        }
      };

      var request = Y.io(uri, cfg);
    }, '.remover');
  });
</script>
<script id="linker-template" type="text/x-handlebars-template">
<div class="link-item">
{{#if ticket_id}}
 <a class="btn btn-primary dropdown-toggle {{#if disabled}}disabled{{/if}}" data-toggle="dropdown" href="#">
   @Messages("ticket.linker.label") <i></i>{{ticket_id}}: {{short_summary}}
   <span class="caret"></span>
 </a>
 <ul id="link-menu" class="dropdown-menu">
   @linkTypes.map { ltype =>
   <li><a href="#" class="linker" data-linktype="@ltype.id.get" data-parent="@ticket.ticketId"><i class="icon-magnet"></i> @Messages("ticket.linker.link", ticket.ticketId, Messages(ltype.name)) <i></i>{{ticket_id}}</a></li>
   @if(ltype.invertable) {
   <li><a href="#" class="linker" data-linktype="@ltype.id.get" data-parent="@ticket.ticketId" data-inverse="true"><i class="icon-magnet"></i> @Messages("ticket.linker.link", ticket.ticketId, Messages(ltype.name + "_INVERT")) <i></i>{{ticket_id}}</a></li>
   }
   }
   <li class="divider"></li>
   <li><a href="/ticket/{{ticket_id}}"><i class="icon-eye-open"></i> @Messages("ticket.linker.view") <i></i>{{ticket_id}}</a></li>
   <li><a href="#" class="remover"><i class="icon-eject"></i> @Messages("ticket.linker.remove") <i></i>{{ticket_id}}</a></li>
 </ul>
{{else}}
<a class="btn" id="btn-start">@Messages("ticket.linker.action")</a>
{{/if}}
</div>
</script>
}


