@(ticket: models.FullTicket,
  markdown: org.clapper.markwrap.MarkWrapParser,
  prevStatus: Option[models.WorkflowStatus],
  nextStatus: Option[models.WorkflowStatus],
  resolutions: List[(String,String)],
  resolveForm: Form[models.Resolution],
  commentForm: Form[models.InitialComment],
  links: List[models.Link],
  comments: chc.Page[org.elasticsearch.search.SearchHit],
  commFacets: Seq[org.elasticsearch.search.facet.terms.longs.InternalLongTermsFacet],
  history: chc.Page[org.elasticsearch.search.SearchHit],
  historyFacets: Seq[org.elasticsearch.search.facet.terms.strings.InternalStringTermsFacet],
  ticketJson: String
)(implicit request: Request[AnyContent])

@import helper.bootstrap._
@import util._

@main(Messages("ticket.with.id", ticket.ticketId)) {
<div id="ticket-body">
</div>
<div class="well ticket-desc">
 @{ ticket.description match { case Some(text) => Html(markdown.parseToHTML(text)); case None => Messages("ticket.description.none") } }
</div>
<h3>@Messages("ticket.links")</h3>
@if(!links.isEmpty) {
<ul>
@links.map { link =>
  @if(link.parentId == ticket.ticketId) {
 <li>@Messages(link.typeName + "_INVERT") <a href="@routes.Ticket.item(link.childId)">@link.childId</a></li>
  } else {
 <li>@Messages(link.typeName) <a href="@routes.Ticket.item(link.parentId)">@link.parentId</a></li>
  }
}
</ul>
}
<ul class="nav nav-tabs">
  <li class="active"><a href="#comments" data-toggle="tab">@Messages("ticket.comment.list")</a></li>
  <li><a href="#history" data-toggle="tab">@Messages("ticket.history.list")</a></li>
</ul>
<div class="tab-content">
  <div class="tab-pane active" id="comments">
   @helper.form(action = routes.Ticket.item(id = ticket.ticketId), 'class -> "navbar-search") {
    <input type="text" name="query" class="search-query" placeholder="@Messages("ticket.comment.search.placeholder")">
   }
   @commtab(
    ticket      = ticket,
    markdown    = markdown,
    commentForm = commentForm,
    comments    = comments,
    facets      = commFacets
   )
  </div>
  <div class="tab-pane" id="history">
   @histtab(
    ticket      = ticket,
    markdown    = markdown,
    history     = history,
    facets      = historyFacets
   )
  </div>
</div>
<script type="text/javascript">
  YUI().use('emperor-models', 'base', 'view', 'node', function (Y) {
    Y.TicketItemView = Y.Base.create('ticketItemView', Y.View, [], {
      events: {
        '.eat': { click: 'eatSlice '}
      },
      template: Y.one("#ticket-header-template").getHTML(),
      initializer: function () {
        var model = this.get('model');

        model.after('change', this.render, this);
        model.after('destroy', this.destroy, this);
      },
      render: function () {
        var container = this.get('container');

        var source   = this.template;
        console.log(source);
        var template = Handlebars.compile(source);
        var html = template(this.get('model').toJSON());

        container.setHTML(html);

        return this;
      },
      // The eatSlice function will handle click events on this view's "Eat a Slice"
      // button.
      eatSlice: function (e) {
        // Call the pie model's eatSlice() function. This will consume a slice of
        // pie (if there are any left) and update the model, thus causing the view
        // to re-render to reflect the new model data.
        this.get('model').eatSlice();
      }
    }, {
      ATTRS: {
        container: {
          valueFn: function () {
            return Y.one('#ticket-body');
          }
        }
      }
    });

    var ticket = new Y.Ticket(@Html(ticketJson));
    var ticketView = new Y.TicketItemView({ model: ticket });
    ticketView.render();
  });
</script>
<script id="ticket-header-template" type="text/x-handlebars-template">
<div class="row-fluid" id="ticket-header" data-ticket="@ticket.ticketId">
 <h2>{{ticket_id}}, {{summary}}</h2>
 <ul id="ticket-info" class="unstyled pull-left">
  <li>
   <span class="label" style="background-color: #{{type_color}}"><label>@Messages("ticket.type")</label> {{type_name}}</span>
  </li>
  <li>
   <span class="label" style="background-color: #{{priority_color}}"><label>@Messages("ticket.priority")</label> {{priority_name}}</span>
  </li>
  <li>
   <span class="label" style="background-color: #{{severity_color}}"><label>@Messages("ticket.severity")</label> {{severity_name}}</span>
  </li>
 </ul>
 <div class="btn-toolbar pull-right">
  <div class="btn-group">
   @defining(request.session.get("link_ticket")) { lt =>
     @lt match {
       case Some(ltid) => {
         <button id="startlink" class="btn @if(ltid == ticket.ticketId) { disabled }" data-ticket="@ticket.ticketId">@Messages("ticket.linker.action")</button>
       }
       case None => {
         <button id="startlink" class="btn" data-ticket="@ticket.ticketId">@Messages("ticket.linker.action")</button>
       }
     }
   }
  </div>
  @if(ticket.resolution.id.isEmpty) {
  <div class="btn-group">
   @prevStatus match {
     case Some(status) => {
   <a href="#status-revert" class="btn btn-warning" data-toggle="modal"><i class="icon-arrow-left icon-white"></i> @Messages("ticket.revert", Messages(status.name))</a>
     }
     case None => { }
   }
   <a href="#" class="btn disabled">@Messages(ticket.status.name)</a>
   @nextStatus match {
     case Some(status) => {
   <a class="btn btn-primary" data-toggle="modal" href="#status-advance">@Messages("ticket.advance", Messages(status.name)) <i class="icon-arrow-right icon-white"></i></a>
     }
     case None => {
   <a href="#" class="btn disabled">@Messages("ticket.advance.end")</a>
     }
   }
  </div>
  }
  <div class="btn-group">
   {{#if resolution_id}}
   <a class="btn btn-danger" data-toggle="modal" href="#unresolver"><i class="icon-repeat icon-white"></i> @Messages("ticket.unresolve")</a>
   {{else}}
   <a class="btn btn-success" data-toggle="modal" href="#resolver"><i class="icon-ok icon-white"></i> @Messages("ticket.resolve")</a>
   {{/if}}
  </div>
 </div>
</div>
</script>
}
