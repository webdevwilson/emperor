@(ticket: models.FullTicket,
  markdown: org.clapper.markwrap.MarkWrapParser,
  resolutions: List[(String,String)],
  resolveForm: Form[models.Resolution],
  commentForm: Form[models.InitialComment],
  comments: chc.Page[org.elasticsearch.search.SearchHit],
  commFacets: Seq[org.elasticsearch.search.facet.terms.longs.InternalLongTermsFacet],
  history: chc.Page[org.elasticsearch.search.SearchHit],
  historyFacets: Seq[org.elasticsearch.search.facet.terms.strings.InternalStringTermsFacet],
  ticketJson: String,
  previousStatus: Option[WorkflowStatus],
  nextStatus: Option[WorkflowStatus],
  linkTypes: List[models.TicketLinkType]
)(implicit request: Request[AnyContent])

@import helper.bootstrap._
@import util._

@main(title = Messages("ticket.with.id", ticket.ticketId), currentProject = Some(ticket.project.id)) {
<div id="ticket-head" data-ticket="@ticket.ticketId">
<div class="row-fluid" id="ticket-header" data-ticket="@ticket.ticketId">
 <h2><a href="@routes.Ticket.edit(ticket.ticketId)" class="btn btn-mini"><i class="icon-edit"></i></a> @Messages("ticket.summary.with.id", ticket.ticketId, ticket.summary)</h2>
 <ul id="ticket-info" class="unstyled pull-left">
  <li>
   <span class="label"><label>@Messages("ticket.resolution")</label> @Messages(ticket.resolution.name.getOrElse("TICK_RESO_UNRESOLVED"))</span>
  </li>
  <li>
   <span class="label" style="background-color: #@ticket.ttype.color"><label>@Messages("ticket.type")</label> @Messages(ticket.ttype.name)</span>
  </li>
  <li>
   <span class="label" style="background-color: #@ticket.priority.color"><label>@Messages("ticket.priority")</label> @Messages(ticket.priority.name)</span>
  </li>
  <li>
   <span class="label" style="background-color: #@ticket.severity.color"><label>@Messages("ticket.severity")</label> @Messages(ticket.severity.name)</span>
  </li>
 </ul>
 <div class="btn-toolbar pull-right">
  @if(ticket.resolution.id.isEmpty) {
  <div class="btn-group">
   @previousStatus match {
    case Some(status) => {
   <a href="#status-revert" class="btn btn-warning" data-toggle="modal"><i class="icon-arrow-left icon-white"></i> @Messages("ticket.revert", Messages(status.name))</a>
    }
    case None => { }
    }
   <a href="#" class="btn disabled">@Messages(ticket.status.name)</a>
   @nextStatus match {
    case Some(status) => {
   <a class="btn btn-primary" data-toggle="modal" id="btn-advance" href="#status-advance">@Messages("ticket.advance", Messages(status.name)) <i class="icon-arrow-right icon-white"></i></a>
    }
    case None => {
   <a href="#" class="btn disabled">@Messages("ticket.advance.end")</a>
    }
   }
  </div>
  }
  <div class="btn-group">
   @if(ticket.resolution.id.isDefined) {
   <a class="btn btn-danger" data-toggle="modal" href="#unresolver"><i class="icon-repeat icon-white"></i> @Messages("ticket.unresolve")</a>
   } else {
   <a class="btn btn-success" data-toggle="modal" href="#resolver"><i class="icon-ok icon-white"></i> @Messages("ticket.resolve")</a>
   }
  </div>
 </div>
</div>
 <div class="well ticket-desc">
  @if(ticket.description) {
    @ticket.description
  } else {
    @Messages("ticket.description.none")
  }
 </div>

</div>
<div id="change-body">
</div>
<h3>@Messages("ticket.links")</h3>
<div id="ticket-links">
</div>
<ul class="nav nav-tabs">
  <li class="active"><a href="#comments" data-toggle="tab">@Messages("ticket.comment.list")</a></li>
  <li><a href="#history" data-toggle="tab">@Messages("ticket.history.list")</a></li>
</ul>
<div class="tab-content">
  <div class="tab-pane active" id="comments">
   @helper.form(action = routes.Ticket.item(id = ticket.ticketId), 'class -> "navbar-search") {
    <input type="text" name="query" class="search-query" placeholder="@Messages("ticket.comment.search.placeholder")">
   }
   @commtab(
    ticket      = ticket,
    markdown    = markdown,
    commentForm = commentForm,
    comments    = comments,
    facets      = commFacets
   )
  </div>
  <div class="tab-pane" id="history">
   @histtab(
    ticket      = ticket,
    markdown    = markdown,
    history     = history,
    facets      = historyFacets
   )
  </div>
</div>
@if(nextStatus.isDefined) {
<div class="modal hide" id="status-advance">
 @helper.form(action = routes.Ticket.status(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.advance", Messages(nextStatus.get.name))</h3>
 </div>
 <div class="modal-body">
  <fieldset>
   <input type="hidden" name="status_id" value="@nextStatus.get.id.get">
   @helper.textarea(field = commentForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xxlarge", 'rows -> 5)
  </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn" data-dismiss="modal">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
}
@if(previousStatus.isDefined) {
<div class="modal hide" id="status-revert">
 @helper.form(action = routes.Ticket.status(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.revert", Messages(previousStatus.get.name))</h3>
 </div>
 <div class="modal-body">
  <fieldset>
   <input type="hidden" name="status_id" value="@previousStatus.get.id.get">
   @helper.textarea(field = commentForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xxlarge", 'rows -> 5)
  </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn" data-dismiss="modal">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
}
<div class="modal hide" id="resolver">
 @helper.form(action = routes.Ticket.doResolve(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.resolve")</h3>
 </div>
 <div class="modal-body">
  <p>@Html(Messages("ticket.resolve.summary", ticket.id.get))</p>
  <fieldset>
   @helper.select(field = resolveForm("resolution_id"), options = resolutions, args = '_label -> Messages("ticket.resolution"))
   @helper.textarea(field = resolveForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xlarge", 'rows -> 5)
  </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn" data-dismiss="modal">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
<div class="modal hide" id="unresolver">
 @helper.form(action = routes.Ticket.doUnResolve(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.unresolve")</h3>
 </div>
 <div class="modal-body">
   <p>@Html(Messages("ticket.unresolve.summary", ticket.ticketId))</p>
   <fieldset>
     @helper.textarea(field = commentForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xxlarge", 'rows -> 5)
   </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn" data-dismiss="modal">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
<script type="text/javascript">
  YUI().use('emperor-models', 'base', 'view', 'node', 'io-base', function (Y) {

    var ticket = new Y.Ticket(@Html(ticketJson));

    var ticketLinks = new Y.TicketLinks({ url: '/api/ticket/link/@ticket.ticketId' });
    ticketLinks.load();

    Y.LinkerView = Y.Base.create('linkerView', Y.View, [], {
      events: {
        '#btn-start': { click: 'start' },
        '.remover': { click: 'stop' },
        '.linker': { click: 'link' }
      },
      template: Y.one("#linker-template").getHTML(),
      initializer: function () {
        var model = this.get('model');

        model.after('change', this.render, this);
        model.after('destroy', this.render, this);
      },
      render: function () {
        var container = this.get('container');
        var source   = this.template;
        var template = Handlebars.compile(source);
        var html = template(this.get('model').toJSON());

        container.setHTML(html);

        return this;
      },
      start: function(e) {
        var model = this.get('model');
        model.set("ticket_id", '@ticket.ticketId').save();
      },
      stop: function(e) {
        var model = this.get('model');
        // Causes a PUT with an empty ticket id. Hackish
        model.set("ticket_id", null).save();
      },
      link: function(e) {
        var model = this.get('model');
        var t = e.currentTarget;
        var type = t.getAttribute('data-linktype');
        var invert = t.getAttribute('data-inverse');

        var ticketId = '@ticket.ticketId';
        var childId = model.get("ticket_id");
        if(invert == 'true') {
          ticketId = model.get("ticket_id");
          childId = '@ticket.ticketId';
        }

        var uri = '/api/ticket/link/' + ticketId

        var link = {
          link_type_id: parseInt(type),
          child_ticket_id: childId
        };

        var cfg = {
            method: 'PUT',
            data: JSON.stringify(link),
            headers: {
              'Content-Type': 'application/json',
            },
        };

        function onSuccess(transactionid, response, arguments) {
          ticketLinks.add(JSON.parse(response.responseText))
        }

        function onFailure(transactionId, response, arguments) {
          Y.ShowAlert('alert-error', response.responseText);
        }

        Y.on('io:success', onSuccess, Y, true);
        Y.on('io:failure', onFailure, Y, true);

        var request = Y.io(uri, cfg);
      }
    }, {
      ATTRS: {
        container: {
          valueFn: function () {
            return Y.one('#linker');
          }
        }
      }
    });

    var linkTicket = new Y.LinkTicket({ id: '@ticket.ticketId' });
    linkTicket.load();

    var linkerView = new Y.LinkerView({ model: linkTicket });
    linkerView.render();

    // Ticket Header
    Y.TicketLinkView = Y.Base.create('ticketLinkView', Y.View, [], {
      events: {
        'a.remover': { click: 'delete' }
      },
      template: Y.one("#link-template").getHTML(),
      initializer: function () {
        var model = this.get('modelList');
        model.after('reset', this.render, this);
        model.after('destroy', this.destroy, this);
        model.after('add', this.render, this);
        model.after('remove', this.render, this);
      },
      render: function () {
        var container = this.get('container');

        var source   = this.template;
        var template = Handlebars.compile(source);
        var html = template({ links: this.get('modelList').toJSON() });

        container.setHTML(html);

        return this;
      },
      delete: function(e) {
        var model = this.get('modelList');
        var t = e.currentTarget;
        var lid = t.getAttribute('data-linkid');

        var link = model.getById(parseInt(lid))
        link.destroy({ remove: true });
      }
    }, {
      ATTRS: {
        container: {
          valueFn: function () {
            return Y.one('#ticket-links');
          }
        }
      }
    });

    var linkView = new Y.TicketLinkView({ modelList: ticketLinks });
    linkView.render();
  });
</script>
<script id="linker-template" type="text/x-handlebars-template">
<div class="link-item">
{{#if ticket_id}}
 <a class="btn btn-primary dropdown-toggle {{#if disabled}}disabled{{/if}}" data-toggle="dropdown" href="#">
   @Messages("ticket.linker.label") <i></i>{{ticket_id}}
   <span class="caret"></span>
 </a>
 <ul id="link-menu" class="dropdown-menu">
   @linkTypes.map { ltype =>
   <li><a href="#" class="linker" data-linktype="@ltype.id.get" data-parent="@ticket.ticketId"><i class="icon-magnet"></i> @Messages("ticket.linker.link", ticket.ticketId, Messages(ltype.name)) <i></i>{{ticket_id}}</a></li>
   @if(ltype.invertable) {
   <li><a href="#" class="linker" data-linktype="@ltype.id.get" data-parent="@ticket.ticketId" data-inverse="true"><i class="icon-magnet"></i> @Messages("ticket.linker.link", ticket.ticketId, Messages(ltype.name + "_INVERT")) <i></i>{{ticket_id}}</a></li>
   }
   }
   <li class="divider"></li>
   <li><a href="/ticket/{{ticket_id}}"><i class="icon-eye-open"></i> @Messages("ticket.linker.view") <i></i>{{ticket_id}}</a></li>
   <li><a href="#" class="remover"><i class="icon-eject"></i> @Messages("ticket.linker.remove") <i></i>{{ticket_id}}</a></li>
 </ul>
{{else}}
<a class="btn" id="btn-start">@Messages("ticket.linker.action")</a>
{{/if}}
</div>
</script>
<script id="link-template" type="text/x-handlebars-template">
<table class="table table-striped table-condensed">
 {{#each links}}
 <tr>
  <td><a href="/ticket/{{parent_id}}" {{#if parent_resolution_id}}class="strike"{{/if}}>{{parent_id}}</a></td>
  <td>{{name_i18n}}</td>
  <td><a href="/ticket/{{child_id}}" {{#if child_resolution_id}}class="strike"{{/if}}>{{child_id}}</a></td>
  <td width="70%">{{child_summary}}</td>
  <td><a class="remover" href="#" data-linkid="{{id}}"><i class="icon-remove"></i></a></td>
 </tr>
 {{/each}}
</table>
</script>
}


