@(ticket: models.FullTicket,
  markdown: org.clapper.markwrap.MarkWrapParser,
  resolutions: List[(String,String)],
  resolveForm: Form[models.Resolution],
  commentForm: Form[models.InitialComment],
  links: List[models.Link],
  comments: chc.Page[org.elasticsearch.search.SearchHit],
  commFacets: Seq[org.elasticsearch.search.facet.terms.longs.InternalLongTermsFacet],
  history: chc.Page[org.elasticsearch.search.SearchHit],
  historyFacets: Seq[org.elasticsearch.search.facet.terms.strings.InternalStringTermsFacet],
  ticketJson: String,
  workflowJson: String,
  linkTypes: List[models.TicketLinkType]
)(implicit request: Request[AnyContent])

@import helper.bootstrap._
@import util._

@main(Messages("ticket.with.id", ticket.ticketId)) {
<div id="ticket-head" data-ticket="@ticket.ticketId">
</div>
<div id="change-body">
</div>
<h3>@Messages("ticket.links")</h3>
@if(!links.isEmpty) {
<ul>
@links.map { link =>
  @if(link.parentId == ticket.ticketId) {
 <li>@Messages(link.typeName + "_INVERT") <a href="@routes.Ticket.item(link.childId)">@link.childId</a></li>
  } else {
 <li>@Messages(link.typeName) <a href="@routes.Ticket.item(link.parentId)">@link.parentId</a></li>
  }
}
</ul>
}
<ul class="nav nav-tabs">
  <li class="active"><a href="#comments" data-toggle="tab">@Messages("ticket.comment.list")</a></li>
  <li><a href="#history" data-toggle="tab">@Messages("ticket.history.list")</a></li>
</ul>
<div class="tab-content">
  <div class="tab-pane active" id="comments">
   @helper.form(action = routes.Ticket.item(id = ticket.ticketId), 'class -> "navbar-search") {
    <input type="text" name="query" class="search-query" placeholder="@Messages("ticket.comment.search.placeholder")">
   }
   @commtab(
    ticket      = ticket,
    markdown    = markdown,
    commentForm = commentForm,
    comments    = comments,
    facets      = commFacets
   )
  </div>
  <div class="tab-pane" id="history">
   @histtab(
    ticket      = ticket,
    markdown    = markdown,
    history     = history,
    facets      = historyFacets
   )
  </div>
</div>
<script type="text/javascript">
  YUI().use('emperor-models', 'base', 'view', 'node', 'io-base', function (Y) {

    var ticket = new Y.Ticket(@Html(ticketJson));

    // Resolve
    Y.ResolverView = Y.Base.create('resolverView', Y.View, [], {
      events: {
        '.cancel': { click: 'close'}
      },
      template: Y.one("#resolver-template").getHTML(),
      initializer: function () {
        var model = this.get('model');

        model.after('change', this.render, this);
        model.after('destroy', this.destroy, this);
      },
      render: function () {
        var container = this.get('container');
        var source   = this.template;
        var template = Handlebars.compile(source);
        var html = template(this.get('model').toJSON());

        container.setHTML(html);

        return this;
      },
      close: function() {
        var container = this.get('container');
        container.setHTML('');
      }
    }, {
      ATTRS: {
        container: {
          valueFn: function () {
            return Y.one('#change-body');
          }
        }
      }
    });

    var resolverView = new Y.ResolverView({ model : ticket });

    // Unresolve
    Y.UnresolverView = Y.Base.create('unresolverView', Y.View, [], {
      events: {
        '.cancel': { click: 'close'}
      },
      template: Y.one("#unresolver-template").getHTML(),
      initializer: function () {
        var model = this.get('model');

        model.after('change', this.render, this);
        model.after('destroy', this.destroy, this);
      },
      render: function () {
        var container = this.get('container');
        var source   = this.template;
        var template = Handlebars.compile(source);
        var html = template(this.get('model').toJSON());

        container.setHTML(html);

        return this;
      },
      close: function() {
        var container = this.get('container');
        container.setHTML('');
      }
    }, {
      ATTRS: {
        container: {
          valueFn: function () {
            return Y.one('#change-body');
          }
        }
      }
    });

    var unresolverView = new Y.UnresolverView({ model : ticket });

    // Advance
    Y.AdvanceView = Y.Base.create('advanceView', Y.View, [], {
      events: {
        '.cancel': { click: 'close'}
      },
      template: Y.one("#advance-template").getHTML(),
      initializer: function () {
        var model = this.get('model');

        model.after('change', this.render, this);
        model.after('destroy', this.destroy, this);
      },
      render: function () {
        var container = this.get('container');
        var source   = this.template;
        var template = Handlebars.compile(source);
        var html = template(this.get('model').toJSON());

        container.setHTML(html);

        return this;
      },
      close: function() {
        var container = this.get('container');
        container.setHTML('');
      }
    }, {
      ATTRS: {
        container: {
          valueFn: function () {
            return Y.one('#change-body');
          }
        }
      }
    });

    var advanceView = new Y.AdvanceView({ model : ticket });

    // Revert
    Y.RevertView = Y.Base.create('revertView', Y.View, [], {
      events: {
        '.cancel': { click: 'close'}
      },
      template: Y.one("#revert-template").getHTML(),
      initializer: function () {
        var model = this.get('model');

        model.after('change', this.render, this);
        model.after('destroy', this.destroy, this);
      },
      render: function () {
        var container = this.get('container');
        var source   = this.template;
        var template = Handlebars.compile(source);
        var html = template(this.get('model').toJSON());

        container.setHTML(html);

        return this;
      },
      close: function() {
        var container = this.get('container');
        container.setHTML('');
      }
    }, {
      ATTRS: {
        container: {
          valueFn: function () {
            return Y.one('#change-body');
          }
        }
      }
    });

    var revertView = new Y.RevertView({ model : ticket });

    // Ticket Header
    Y.TicketHeaderView = Y.Base.create('ticketItemView', Y.View, [], {
      events: {
        '#btn-resolver': { click: 'resolve' },
        '#btn-unresolver': { click: 'unresolve' },
        '#btn-advance': { click: 'advance' },
        '#btn-revert': { click: 'revert' }
      },
      template: Y.one("#ticket-header-template").getHTML(),
      initializer: function () {
        var model = this.get('model');

        model.after('change', this.render, this);
        model.after('destroy', this.destroy, this);
      },
      render: function () {
        var container = this.get('container');

        var source   = this.template;
        var template = Handlebars.compile(source);
        var html = template(this.get('model').toJSON());

        container.setHTML(html);

        return this;
      },
      resolve: function (e) {
        resolverView.render();
      },
      unresolve: function(e) {
        unresolverView.render();
      },
      advance: function (e) {
        advanceView.render();
      },
      revert: function(e) {
        revertView.render();
      }
    }, {
      ATTRS: {
        container: {
          valueFn: function () {
            return Y.one('#ticket-head');
          }
        }
      }
    });

    var ticketHeadView = new Y.TicketHeaderView({ model: ticket });
    ticketHeadView.render();

    Y.LinkerView = Y.Base.create('linkerView', Y.View, [], {
      events: {
        '#btn-start': { click: 'start' },
        '.remover': { click: 'stop' },
        '.linker': { click: 'link' }
      },
      template: Y.one("#linker-template").getHTML(),
      initializer: function () {
        var model = this.get('model');

        model.after('change', this.render, this);
        model.after('destroy', this.render, this);
      },
      render: function () {
        var container = this.get('container');
        var source   = this.template;
        var template = Handlebars.compile(source);
        var html = template(this.get('model').toJSON());

        container.setHTML(html);

        return this;
      },
      start: function(e) {
        var model = this.get('model');
        model.set("ticket_id", @ticket.ticketId).save();
      },
      stop: function(e) {
        var model = this.get('model');
        // Causes a PUT with an empty ticket id. Hackish
        model.set("ticket_id", null).save();
      },
      link: function(e) {
        var model = this.get('model');
        var t = e.currentTarget;
        var type = t.getAttribute('data-linktype');
        var invert = t.getAttribute('data-inverse');

        var ticketId = '@ticket.ticketId';
        var childId = model.get("ticket_id");
        if(invert == true) {
          ticketId = model.get("ticket_id");
          childId = '@ticket.ticketId';
        }

        var uri = '/api/ticket/link/' + ticketId

        var link = {
          link_type_id: parseInt(type),
          child_ticket_id: childId
        };

        var cfg = {
            method: 'PUT',
            data: JSON.stringify(link),
            headers: {
              'Content-Type': 'application/json',
            },
        };

        function onSuccess(transactionid, response, arguments) {
          console.log("yay!");
        }

        // Subscribe to "io.success".
        Y.on('io:success', onSuccess, Y, true);

        var request = Y.io(uri, cfg);
      }
    }, {
      ATTRS: {
        container: {
          valueFn: function () {
            return Y.one('#linker');
          }
        }
      }
    });

    var linkTicket = new Y.LinkTicket({ id: '@ticket.ticketId' });
    linkTicket.load();

    var linkerView = new Y.LinkerView({ model: linkTicket });
    linkerView.render();
  });
</script>
<script id="ticket-header-template" type="text/x-handlebars-template">
<div class="row-fluid" id="ticket-header" data-ticket="@ticket.ticketId">
 <h2>{{ticket.ticket_id}}, {{ticket.summary}}</h2>
 <ul id="ticket-info" class="unstyled pull-left">
  <li>
   <span class="label" style="background-color: #{{ticket.type_color}}"><label>@Messages("ticket.type")</label> {{ticket.type_name_i18n}}</span>
  </li>
  <li>
   <span class="label" style="background-color: #{{ticket.priority_color}}"><label>@Messages("ticket.priority")</label> {{ticket.priority_name_i18n}}</span>
  </li>
  <li>
   <span class="label" style="background-color: #{{ticket.severity_color}}"><label>@Messages("ticket.severity")</label> {{ticket.severity_name_i18n}}</span>
  </li>
 </ul>
 <div class="btn-toolbar pull-right">
  {{#if ticket.resolution_id}}
  {{else}}
  <div class="btn-group">
   {{#if workflow.previous}}
   <a href="#status-revert" class="btn btn-warning" id="btn-revert"><i class="icon-arrow-left icon-white"></i>  @Messages("ticket.revert") <i></i>{{workflow.previous.name_i18n}}</a>
   {{/if}}
   <a href="#" class="btn disabled">{{ticket.status_name_i18n}}</a>
   {{#if workflow.next}}
   <a class="btn btn-primary" id="btn-advance" href="#status-advance"> @Messages("ticket.advance") <i></i>{{workflow.next.name_i18n}} <i class="icon-arrow-right icon-white"></i></a>
   {{else}}
   <a href="#" class="btn disabled">@Messages("ticket.advance.end")</a>
   {{/if}}
  </div>
  {{/if}}
  <div class="btn-group">
   {{#if ticket.resolution_id}}
   <a class="btn btn-danger" id="btn-unresolver" href="#unresolver"><i class="icon-repeat icon-white"></i> @Messages("ticket.unresolve")</a>
   {{else}}
   <a class="btn btn-success" id="btn-resolver" href="#resolver"><i class="icon-ok icon-white"></i> @Messages("ticket.resolve")</a>
   {{/if}}
  </div>
 </div>
</div>
 <div class="well ticket-desc">
  {{#if ticket.description}}
  {{{ticket.description}}}
  {{else}}
  @Messages("ticket.description.none")
  {{/if}}
 </div>
</script>
<script id="resolver-template" type="text/x-handlebars-template">
<div id="resolver" class="modal">
 @helper.form(action = routes.Ticket.doResolve(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close cancel">×</button>
  <h3>@Messages("ticket.resolve")</h3>
 </div>
 <div class="modal-body">
  <p>@Html(Messages("ticket.resolve.summary", ticket.id.get))</p>
  <fieldset>
   @helper.select(field = resolveForm("resolution_id"), options = resolutions, args = '_label -> Messages("ticket.resolution"))
   @helper.textarea(field = resolveForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xlarge", 'rows -> 5)
  </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn cancel">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
</script>
<script id="unresolver-template" type="text/x-handlebars-template">
<div id="unresolver" class="modal">
 @helper.form(action = routes.Ticket.doUnResolve(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.unresolve")</h3>
 </div>
 <div class="modal-body">
   <p>@Html(Messages("ticket.unresolve.summary", ticket.ticketId))</p>
   <fieldset>
     @helper.textarea(field = commentForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xlarge", 'rows -> 5)
   </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn" data-dismiss="modal">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
</script>
<script id="advance-template" type="text/x-handlebars-template">
<div id="status-advance" class="modal">
 @helper.form(action = routes.Ticket.status(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close cancel">×</button>
  <h3>@Messages("ticket.advance") <i></i>{{workflow.next.name_i18n}}</h3>
 </div>
 <div class="modal-body">
  <fieldset>
   <input type="hidden" name="status_id" value="{{workflow.next.status_id}}">
   @helper.textarea(field = commentForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xlarge", 'rows -> 5)
  </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn cancel">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
</script>
<script id="revert-template" type="text/x-handlebars-template">
<div id="status-revert" class="modal">
 @helper.form(action = routes.Ticket.status(ticket.ticketId), args = 'method -> "POST") {
 <div class="modal-header">
  <button type="button" class="close cancel" data-dismiss="modal">×</button>
  <h3>@Messages("ticket.revert") <i></i>{{workflow.previous.name_i18n}}</h3>
 </div>
 <div class="modal-body">
  <fieldset>
   <input type="hidden" name="status_id" value="{{workflow.previous.status_id}}">
   @helper.textarea(field = commentForm("comment"), args = '_label -> Messages("ticket.comment"), 'class -> "input-xlarge", 'rows -> 5)
  </fieldset>
 </div>
 <div class="modal-footer">
  <a href="#" class="btn cancel">@Messages("form.cancel")</a>
  <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> @Messages("form.submit")</button>
 </div>
 }
</div>
</script>
<script id="linker-template" type="text/x-handlebars-template">
<div class="link-item">
{{#if ticket_id}}
 <a class="btn btn-primary dropdown-toggle {{#if disabled}}disabled{{/if}}" data-toggle="dropdown" href="#">
   @Messages("ticket.linker.label") <i></i>{{ticket_id}}
   <span class="caret"></span>
 </a>
 <ul id="link-menu" class="dropdown-menu">
   @linkTypes.map { ltype =>
   <li><a href="#" class="linker" data-linktype="@ltype.id.get" data-parent="@ticket.ticketId"><i class="icon-magnet"></i> @Messages("ticket.linker.link", Messages(ltype.name), ticket.ticketId)</a></li>
   @if(ltype.invertable) {
   <li><a href="#" class="linker" data-linktype="@ltype.id.get" data-parent="@ticket.ticketId" data-inverse="true"><i class="icon-magnet"></i> @Messages("ticket.linker.link", Messages(ltype.name + "_INVERT"), ticket.ticketId)</a></li>
   }
   }
   <li class="divider"></li>
   <li><a href="/ticket/{{ticket_id}}"><i class="icon-eye-open"></i> @Messages("ticket.linker.view") <i></i>{{ticket_id}}</a></li>
   <li><a href="#" class="remover"><i class="icon-eject"></i> @Messages("ticket.linker.remove") <i></i>{{ticket_id}}</a></li>
 </ul>
{{else}}
<a class="btn" id="btn-start">@Messages("ticket.linker.action")</a>
{{/if}}
</div>
</script>

}


